<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Delegados - LIBRE</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 600px; width: 100%; position: relative; }
        .logo { position: absolute; top: 20px; right: 20px; width: 120px; height: auto; }
        h2 { color: #1d4ed8; margin-top: 0; padding-right: 130px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #374151; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; background-color: #fff; }
        select:disabled { background-color: #e5e7eb; }
        button { width: 100%; padding: 12px; margin-top: 25px; background-color: #1d4ed8; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .message-container { min-height: 60px; margin-top: 20px; }
        .message { padding: 15px; border-radius: 6px; text-align: center; font-weight: bold; display: none; }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
        .loader { text-align: center; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <img class="logo" src="https://i.postimg.cc/HxFwz5gN/00-LIBRE-COCHABAMBA-OFICIAL.png" alt="Logo LIBRE">
        <h2>Registro de Delegados Electorales de LIBRE</h2>
        
        <div id="loader" class="loader">
            <p>Cargando datos del formulario...</p>
        </div>

        <form id="registroForm" style="display:none;">
            <div id="message-container">
                <div id="message-box" class="message"></div>
            </div>

            <label for="nombre">Nombre Completo:</label>
            <input type="text" id="nombre" name="nombre" required>

            <label for="ci">Cédula de Identidad:</label>
            <input type="text" id="ci" name="ci" required>

            <label for="telefono">Número de Contacto:</label>
            <input type="text" id="telefono" name="telefono" required>

            <label for="circunscripcionSelect">Circunscripción:</label>
            <select id="circunscripcionSelect" required>
                <option value="">Cargando...</option>
            </select>

            <label for="distritoSelect">Distrito:</label>
            <select id="distritoSelect" disabled required>
                <option value="">Seleccione una circunscripción primero</option>
            </select>

            <label for="zonaSelect">Zona:</label>
            <select id="zonaSelect" disabled required>
                <option value="">Seleccione un distrito primero</option>
            </select>

            <label for="recintoSelect">Recinto en el que Votará:</label>
            <select id="recintoSelect" disabled required>
                <option value="">Seleccione una zona primero</option>
            </select>

            <button type="submit" id="submitButton">Registrar</button>
        </form>
    </div>

    <script>
        // URL de la aplicación web de Google Apps Script. ¡YA ESTÁ CORREGIDA!
        const googleWebAppUrl = "https://script.google.com/macros/s/AKfycbxaWlgYSxtaSSc_uYI8ARCeKjSZrJ8viAaAolI2wTJVWcV6la-yGSwSwqk0iBlpywIOqQ/exec";

        let datosCompletos = {};

        const form = document.getElementById('registroForm');
        const loader = document.getElementById('loader');
        const circunscripcionSelect = document.getElementById('circunscripcionSelect');
        const distritoSelect = document.getElementById('distritoSelect');
        const zonaSelect = document.getElementById('zonaSelect');
        const recintoSelect = document.getElementById('recintoSelect');
        const submitButton = document.getElementById('submitButton');
        const messageBox = document.getElementById('message-box');
        
        function mostrarMensaje(texto, tipo) {
            messageBox.textContent = texto;
            messageBox.className = 'message'; // Limpiar clases
            if (tipo === 'success' || tipo === 'error') {
                messageBox.classList.add(tipo);
                messageBox.style.display = 'block';
            } else {
                messageBox.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch(googleWebAppUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`Error de red al cargar datos: ${response.statusText}`);
                    return response.json();
                })
                .then(result => {
                    if (result.status === 'success') {
                        datosCompletos = result.data;
                        cargarCircunscripciones();
                        loader.style.display = 'none';
                        form.style.display = 'block';
                    } else {
                        throw new Error(result.message);
                    }
                })
                .catch(error => {
                    loader.innerHTML = `<p style="color: red;"><b>Error Crítico:</b> No se pudieron cargar los datos de los recintos desde Google Sheets.<br><small>Detalle: ${error.message}</small></p>`;
                });
        });
        
        function poblarSelect(selectElement, items, placeholder) {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            items.sort((a, b) => a.localeCompare(b, undefined, {numeric: true})).forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }
        
        function resetSelects(selectNames) {
            const placeholders = {
                circunscripcion: "Seleccione una circunscripción",
                distrito: "Seleccione un distrito",
                zona: "Seleccione una zona",
                recinto: "Seleccione un recinto"
            };
            selectNames.forEach(name => {
                const select = document.getElementById(`${name}Select`);
                if(select) {
                    select.innerHTML = `<option value="">${placeholders[name]}</option>`;
                    if(name !== 'circunscripcion') select.disabled = true;
                }
            });
        }

        function cargarCircunscripciones() {
            const circunscripciones = Object.keys(datosCompletos);
            poblarSelect(circunscripcionSelect, circunscripciones, "Seleccione una circunscripción");
        }
        
        circunscripcionSelect.addEventListener('change', () => {
            resetSelects(['distrito', 'zona', 'recinto']);
            const circ = circunscripcionSelect.value;
            if (circ && datosCompletos[circ]) {
                const distritos = Object.keys(datosCompletos[circ]);
                poblarSelect(distritoSelect, distritos, "Seleccione un distrito");
                distritoSelect.disabled = false;
            }
        });

        distritoSelect.addEventListener('change', () => {
            resetSelects(['zona', 'recinto']);
            const circ = circunscripcionSelect.value;
            const dist = distritoSelect.value;
            if (dist && datosCompletos[circ]?.[dist]) {
                const zonas = Object.keys(datosCompletos[circ][dist]);
                poblarSelect(zonaSelect, zonas, "Seleccione una zona");
                zonaSelect.disabled = false;
            }
        });

        zonaSelect.addEventListener('change', () => {
            resetSelects(['recinto']);
            const circ = circunscripcionSelect.value;
            const dist = distritoSelect.value;
            const zona = zonaSelect.value;
            if (zona && datosCompletos[circ]?.[dist]?.[zona]) {
                const recintos = datosCompletos[circ][dist][zona];
                poblarSelect(recintoSelect, recintos, "Seleccione un recinto");
                recintoSelect.disabled = false;
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Registrando...';
            mostrarMensaje('', 'limpiar');

            const data = {
                nombre: document.getElementById('nombre').value,
                ci: document.getElementById('ci').value,
                telefono: document.getElementById('telefono').value,
                circunscripcion: circunscripcionSelect.value,
                distrito: distritoSelect.value,
                zona: zonaSelect.value,
                recinto: recintoSelect.value,
            };

            fetch(googleWebAppUrl, {
                method: 'POST',
                mode: 'cors',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' },
            })
            .then(res => {
                if (!res.ok) throw new Error("Error en la respuesta del servidor.");
                return res.json();
            })
            .then(response => {
                if (response.status === 'success') {
                    mostrarMensaje('¡Gracias por registrarte! El formulario se reiniciará en 5 segundos.', 'success');
                    setTimeout(() => {
                        form.reset();
                        resetSelects(['distrito', 'zona', 'recinto']);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Registrar';
                        mostrarMensaje('', 'limpiar');
                    }, 5000);
                } else {
                    throw new Error(response.message || 'Ocurrió un error desconocido en el servidor.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje(`Error al enviar: ${error.message}. Por favor, inténtalo de nuevo.`, 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Registrar';
            });
        });
    </script>
</body>
</html>
